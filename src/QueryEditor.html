<div class="query-editor">
  <h3>Options</h3>
  <div class="options-editor">
    {{#if remainingOptions.length}}
      <div>
        Add Option:
        <select bind:value="__newOption" on:change="addOption()">
          <option selected value="">
            - Select an Option -
          </option>
          {{#each remainingOptions as option}}
            <option value="{{option}}">
              {{option}}
            </option>
          {{/each}}
        </select>
      </div>
    {{/if}}
    <pre>{</pre>
    {{#each optionsKeysTypes as option}}
      <div class="option">
        <div class="name">
          {{option.key}}:
        </div>
        <div class="value">
          {{#if option.type === "class"}}
            <select bind:value="options[option.key]">
              {{#each supportedClasses as curClass}}
                <option value="{{curClass.class}}">
                  {{curClass.class}}
                </option>
              {{/each}}
            </select>
          {{elseif option.type === "int" || option.type === "boolean" || option.type === "string"}}
            <ValueEditor bind:value="options[option.key]" valueTypeInitial="{{option.type}}" allowedTypes="{{[option.type]}}"></ValueEditor>
          {{else}}
            <select bind:value="options[option.key]">
              {{#each option.type as enumVal}}
                <option value="{{enumVal}}">
                  {{enumVal}}
                </option>
              {{/each}}
            </select>
          {{/if}}
        </div>
        <div class="remove">
          <button on:click="removeOption(option.key)">Remove</button>
        </div>
      </div>
    {{/each}}
    <pre>}</pre>
  </div>
  <h3>Selectors</h3>
  <div class="selector-editor">
    <div>
      <button on:click="addSelector()">Add Selector</button>
    </div>
    {{#each selectors as selector, index}}
      <SelectorEditor bind:selector on:remove="removeSelector(index)"></SelectorEditor>
    {{/each}}
  </div>
  {{#if showQuery}}
    <h3>Query</h3>
    <div class="query-result">
      <pre class="query">{{queryText}}</pre>
    </div>
  {{/if}}
</div>

<script>
  import SelectorEditor from './SelectorEditor.html';
  import ValueEditor from './ValueEditor.html';

  export default {
    data () {
      return {
        __newOption: "",
        supportedClasses: [],
        supportedOptions: {
          "class": "class",
          "limit": "int",
          "offset": "int",
          "reverse": "boolean",
          "sort": ["cdate", "mdate", "guid"],
          "skip_ac": "boolean"
        },
        options: {},
        selectors: [],
        showQuery: true
      }
    },

    computed: {
      remainingOptions: (options, supportedOptions) => Object.keys(supportedOptions).filter((i) => !options.hasOwnProperty(i)),
      optionsKeysTypes: (options, supportedOptions) => Object.keys(options).map((key) => ({key, type: supportedOptions[key]})),
      queryText: (options, selectors) => {
        let json = JSON.stringify([options, ...selectors], null, 2);
        const regex = /\[\s*([^\[\]]*)(?:[\t\n]+|\s{2,})([^\[\]]*)\s*\]/g;
        const regex2 = /\[\s*([^\[\]]*[^\[\]\s])\s+\]/g;
        while (json.match(regex)) {
          json = json.replace(regex, "[$1 $2]");
        }
        while (json.match(regex2)) {
          json = json.replace(regex2, "[$1]");
        }
        return "Nymph.getEntities("+json.slice(1, -1)+")";
      }
    },

    methods: {
      addOption () {
        const options = this.get("options");
        const newOption = this.get("__newOption");
        const supportedOptions = this.get("supportedOptions");

        if (newOption === "") {
          return;
        }

        if (!(newOption in options)) {
          options[newOption] = this.getDefaultValue(supportedOptions[newOption]);
        }

        this.set({
          options,
          __newOption: ""
        });
      },

      removeOption (option) {
        const options = this.get("options");
        delete options[option];
        this.set({options});
      },

      getDefaultValue (type) {
        switch (type) {
          case "class":
            const classes = this.get("supportedClasses");
            return classes.length ? classes[0].class : '';
          case "int":
            return 0;
          case "float":
            return 0.0;
          case "boolean":
            return true;
          case "string":
            return "";
          case "date":
            return Date.now();
          default:
            if (Array.isArray(type)) {
              return type[0];
            }
            return "";
        }
      },

      addSelector () {
        const selectors = this.get("selectors");
        selectors.push({type: '&'});
        this.set({selectors});
      },

      removeSelector (index) {
        const selectors = this.get("selectors");
        selectors.splice(index, 1);
        this.set({selectors});
      }
    },

    components: {
      SelectorEditor,
      ValueEditor
    }
  };
</script>

<style>
  .query-editor {
    font-family: monospace;
  }

  .options-editor, .selector-editor, .selector-editor .selector {
    padding-left: 1em;
    display: flex;
    flex-direction: column;
  }
  .options-editor .option, .selector-editor .selector .clause {
    padding: .5em 1em;
    display: flex;
    flex-direction: row;
  }

  .query-result {
    border: 1px solid;
  }
  .query-result .query {
    font-family: monospace;
    margin: 0;
    padding: 1em;
    overflow: auto;
    max-height: 200px;
  }
</style>
